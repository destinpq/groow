// Vendor Dashboard - Fixed useAuthStore import
import React, { useEffect, useState } from 'react';
import { 
  Row, 
  Col, 
  Card, 
  Statistic, 
  Table, 
  Tag, 
  Button, 
  List, 
  Avatar, 
  Badge, 
  Progress, 
  Space, 
  Typography, 
  Spin, 
  message,
  Alert,
  Tabs,
  Select,
  DatePicker,
  Tooltip
} from 'antd';
import {
  DollarOutlined,
  ShoppingOutlined,
  ShoppingCartOutlined,
  RiseOutlined,
  EyeOutlined,
  BellOutlined,
  StarOutlined,
  UserOutlined,
  AlertOutlined,
  CheckCircleOutlined,
  ClockCircleOutlined,
  ArrowUpOutlined,
  ArrowDownOutlined,
  FireOutlined,
  ThunderboltOutlined,
  BarChartOutlined,
  LineChartOutlined,
} from '@ant-design/icons';
import { Line, Column, Pie, Area, Gauge, Heatmap } from '@ant-design/charts';
import { formatPieLabelContent } from '@/utils/chartHelpers';
import { useAuthStore } from '@/store/auth';
import { vendorAPI } from '../../services/api/vendors';
import { ordersAPI } from '../../services/api/orders';
import { productAPI } from '../../services/api/products';
import { analyticsAPI } from '../../services/api/analytics';
import dayjs from 'dayjs';

const { Text, Title } = Typography;
const { RangePicker } = DatePicker;

// Enhanced interfaces for analytics data
interface DashboardStats {
  totalRevenue: number;
  revenueGrowth: number;
  totalOrders: number;
  ordersGrowth: number;
  averageOrderValue: number;
  aovGrowth: number;
  conversionRate: number;
  conversionGrowth: number;
  customerRetention: number;
  retentionGrowth: number;
  averageRating: number;
  totalReviews: number;
  monthlySales: any[];
  topProducts: Array<{
    id: string;
    name: string;
    revenue: number;
    orders: number;
    growth: number;
  }>;
}

interface RealTimeMetrics {
  currentVisitors: number;
  activeOrders: number;
  todayRevenue: number;
  conversionRate: number;
  recentOrders: any[];
  topPages: { page: string; visitors: number }[];
  system_health: { status: 'healthy' | 'warning' | 'critical'; uptime: number };
  live_transactions: Array<{ amount: number; customer: string; product: string; timestamp: string }>;
}

interface AnalyticsData {
  salesMetrics: any;
  revenueChart: any[];
  topProducts: any[];
  customerInsights: any;
  trafficOverview: any[];
  recentActivity: any[];
  quickInsights: any[];
  performanceIndicators: Record<string, { value: number; target: number; status: 'on_track' | 'at_risk' | 'behind' }>;
}

const VendorDashboard = () => {
  const { isAuthenticated, token } = useAuthStore();
  const [loading, setLoading] = useState(true);
  const [realTimeLoading, setRealTimeLoading] = useState(false);
  const [stats, setStats] = useState<DashboardStats | null>(null);
  const [realTimeData, setRealTimeData] = useState<RealTimeMetrics | null>(null);
  const [analyticsData, setAnalyticsData] = useState<AnalyticsData | null>(null);
  const [recentOrders, setRecentOrders] = useState<any[]>([]);
  const [services, setServices] = useState<any[]>([]);
  const [alerts, setAlerts] = useState<any[]>([]);
  const [activeTab, setActiveTab] = useState('overview');
  const [timeRange, setTimeRange] = useState('7d');
  const [selectedMetrics, setSelectedMetrics] = useState(['revenue', 'orders', 'customers']);

  useEffect(() => {
    // Only fetch data if authenticated and token is available
    if (!isAuthenticated || !token) {
      console.log('[VENDOR DASHBOARD] Not authenticated, skipping API calls');
      setLoading(false);
      return;
    }

    fetchDashboardData();
    fetchRealTimeMetrics();
    fetchAlerts();
    
    // Set up real-time updates
    const interval = setInterval(fetchRealTimeMetrics, 30000); // Update every 30 seconds
    return () => clearInterval(interval);
  }, [timeRange, isAuthenticated, token]);

  const fetchDashboardData = async () => {
    try {
      setLoading(true);
      
      // Calculate date range for analytics
      const endDate = dayjs().format('YYYY-MM-DD');
      const startDate = dayjs().subtract(parseInt(timeRange), 'days').format('YYYY-MM-DD');
      
      // Fetch enhanced analytics dashboard data
      const [
        dashboardResponse,
        vendorStatsResponse,
      ] = await Promise.all([
        analyticsAPI.getDashboardData({ 
          startDate,
          endDate,
          granularity: 'day' 
        }),
        vendorAPI.reviews.getStats(),
      ]);

      setAnalyticsData(dashboardResponse);
      
      // Transform vendor stats to match our interface
      const vendorStats = vendorStatsResponse.data;
      setStats({
        totalRevenue: dashboardResponse.salesMetrics?.totalRevenue || 0,
        revenueGrowth: dashboardResponse.salesMetrics?.growth?.revenue || 0,
        totalOrders: dashboardResponse.salesMetrics?.totalOrders || 0,
        ordersGrowth: dashboardResponse.salesMetrics?.growth?.orders || 0,
        averageOrderValue: dashboardResponse.salesMetrics?.averageOrderValue || 0,
        aovGrowth: dashboardResponse.salesMetrics?.growth?.aov || 0,
        conversionRate: dashboardResponse.salesMetrics?.conversionRate || 0,
        conversionGrowth: dashboardResponse.salesMetrics?.growth?.conversion || 0,
        customerRetention: dashboardResponse.customerInsights?.retentionRate || 0,
        retentionGrowth: 0, // Calculate from historical data
        topProducts: (dashboardResponse.topProducts || []).map((product: any) => ({
          id: product.id,
          name: product.name,
          revenue: product.revenue,
          orders: product.totalSold || 0,
          growth: ((product.revenue / (product.revenue - 1000)) - 1) * 100, // Mock growth calculation
        })),
        // Legacy compatibility
        averageRating: vendorStats.averageRating || 4.5,
        totalReviews: vendorStats.totalReviews || 0,
        monthlySales: dashboardResponse.revenueChart || [],
      });
      
      setRecentOrders(dashboardResponse.recentActivity || []); // Use analytics activity data
      setServices((dashboardResponse.topProducts || []).map((p: any) => ({
        ...p,
        isActive: p.inventory > 0,
        stockQuantity: p.inventory || 0,
      }))); // Transform analytics products data

    } catch (error: any) {
      message.error(error.message || 'Failed to load dashboard data');
      console.error('Dashboard fetch error:', error);
    } finally {
      setLoading(false);
    }
  };

  const fetchRealTimeMetrics = async () => {
    try {
      setRealTimeLoading(true);
      const realTimeResponse = await analyticsAPI.getRealTimeMetrics();
      setRealTimeData(realTimeResponse);
    } catch (error: any) {
      console.error('Real-time metrics error:', error);
    } finally {
      setRealTimeLoading(false);
    }
  };

  const fetchAlerts = async () => {
    try {
      const alertsResponse = await analyticsAPI.getAlerts({ 
        status: 'active',
        priority: 'medium' 
      });
      setAlerts(alertsResponse.alerts || []);
    } catch (error: any) {
      console.error('Alerts fetch error:', error);
    }
  };

  // Helper functions for data formatting
  const formatCurrency = (value: number) => `$${value?.toLocaleString('en-US', { minimumFractionDigits: 2 }) || '0.00'}`;
  
  const formatGrowth = (growth: number) => {
    const color = growth >= 0 ? '#52c41a' : '#ff4d4f';
    const icon = growth >= 0 ? <ArrowUpOutlined /> : <ArrowDownOutlined />;
    return (
      <span style={{ color, fontSize: 12 }}>
        {icon} {Math.abs(growth).toFixed(1)}%
      </span>
    );
  };

  const getStatusColor = (status: string) => {
    const colors = {
      'on_track': '#52c41a',
      'at_risk': '#faad14', 
      'behind': '#ff4d4f',
      'healthy': '#52c41a',
      'warning': '#faad14',
      'critical': '#ff4d4f',
    };
    return colors[status as keyof typeof colors] || '#d9d9d9';
  };

  if (loading) {
    return (
      <div style={{ padding: '80px 0', textAlign: 'center' }}>
        <Spin size="large" />
      </div>
    );
  }

  // Enhanced data processing with analytics
  const salesData = stats?.monthlySales || [];
  const activeServices = services.filter((p: any) => p.isActive).length;
  const outOfStock = services.filter((p: any) => p.stockQuantity === 0).length;
  const pendingOrders = recentOrders.filter(o => o.status === 'pending').length;
  const topProducts = stats?.topProducts || [];

  // Enhanced analytics data from the dashboard stats
  const revenueGrowth = stats?.revenueGrowth || 0;
  const ordersGrowth = stats?.ordersGrowth || 0;
  const conversionGrowth = stats?.conversionGrowth || 0;
  const averageRating = stats?.averageRating || 4.5;
  const totalReviews = stats?.totalReviews || 0;
  const totalRevenue = stats?.totalRevenue || 0;
  const totalOrders = stats?.totalOrders || 0;

  // Real-time data overlay
  const currentRevenue = realTimeData?.todayRevenue || totalRevenue;
  const currentOrders = realTimeData?.activeOrders || totalOrders;

  const serviceStatusData = [
    { status: 'Active', count: activeServices, color: '#52c41a' },
    { status: 'Unavailable', count: outOfStock, color: '#ff4d4f' },
    { status: 'Draft', count: services.length - activeServices - outOfStock, color: '#faad14' },
  ];

  // Enhanced charts configuration
  const salesChartData = salesData.map((item, index) => ({
    month: item.month,
    sales: item.sales,
    target: (item.sales * 1.2), // 20% growth target
    trend: index > 0 ? ((item.sales - salesData[index - 1].sales) / salesData[index - 1].sales) * 100 : 0
  }));

  // Customer analytics chart data (using analytics data if available)
  const customerGrowthData = analyticsData?.customerInsights?.monthlyGrowth || [];

  const orderColumns = [
    { title: 'Order #', dataIndex: 'orderNumber', key: 'orderNumber' },
    { title: 'Customer ID', dataIndex: 'customerId', key: 'customerId', ellipsis: true },
    { 
      title: 'Total', 
      dataIndex: 'total', 
      key: 'total', 
      render: (total: number) => `$${total?.toFixed(2) || '0.00'}` 
    },
    {
      title: 'Status',
      dataIndex: 'status',
      key: 'status',
      render: (status: string) => {
        const colors: Record<string, string> = {
          pending: 'blue',
          confirmed: 'cyan',
          processing: 'orange',
          shipped: 'purple',
          delivered: 'green',
          cancelled: 'red',
        };
        return <Tag color={colors[status] || 'default'}>{status?.toUpperCase()}</Tag>;
      },
    },
    { 
      title: 'Date', 
      dataIndex: 'createdAt', 
      key: 'createdAt',
      render: (date: string) => new Date(date).toLocaleDateString()
    },
    {
      title: 'Action',
      key: 'action',
      render: (_: any, record: any) => (
        <Button type="link" icon={<EyeOutlined />} onClick={() => window.location.href = `/vendor/orders/${record.id}`}>
          View
        </Button>
      ),
    },
  ];

  const lineChartConfig = {
    data: salesData,
    xField: 'month',
    yField: 'sales',
    point: { size: 5, shape: 'circle' },
    smooth: true,
    color: '#1890ff',
  };

  const serviceStatusConfig = {
    data: serviceStatusData,
    angleField: 'count',
    colorField: 'status',
    radius: 0.8,
    label: {
      type: 'outer',
      content: formatPieLabelContent,
    },
    interactions: [{ type: 'element-active' }],
  };

  return (
    <div style={{ padding: 24 }}>
      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 24 }}>
        <Title level={3}>IT Services Provider Dashboard</Title>
        <Badge count={2} offset={[-5, 5]}>
          <Button icon={<BellOutlined />}>Notifications</Button>
        </Badge>
      </div>
      
      {/* Performance Metrics */}
      <Row gutter={[16, 16]}>
        <Col xs={24} sm={12} lg={6}>
          <Card>
            <Statistic
              title="Total Revenue"
              value={totalRevenue}
              prefix={<DollarOutlined />}
              precision={2}
              valueStyle={{ color: '#3f8600' }}
            />
            <Progress percent={75} size="small" showInfo={false} strokeColor="#3f8600" />
            <Text type="secondary" style={{ fontSize: 12 }}>
              <RiseOutlined style={{ color: '#3f8600' }} /> Growing revenue
            </Text>
          </Card>
        </Col>
        
        <Col xs={24} sm={12} lg={6}>
          <Card>
            <Statistic
              title="Total IT Services"
              value={services.length}
              prefix={<ShoppingOutlined />}
              valueStyle={{ color: '#1890ff' }}
            />
            <Progress percent={92} size="small" showInfo={false} />
            <Text type="secondary" style={{ fontSize: 12 }}>
              {activeServices} active, {outOfStock} unavailable
            </Text>
          </Card>
        </Col>
        
        <Col xs={24} sm={12} lg={6}>
          <Card>
            <Statistic
              title="Total Orders"
              value={totalOrders}
              prefix={<ShoppingCartOutlined />}
              valueStyle={{ color: '#cf1322' }}
            />
            <Progress percent={68} size="small" showInfo={false} strokeColor="#cf1322" />
            <Text type="secondary" style={{ fontSize: 12 }}>
              {pendingOrders} pending processing
            </Text>
          </Card>
        </Col>
        
        <Col xs={24} sm={12} lg={6}>
          <Card>
            <Statistic
              title="Customer Rating"
              value={averageRating}
              prefix={<StarOutlined />}
              suffix="/ 5"
              valueStyle={{ color: '#faad14' }}
            />
            <Progress percent={94} size="small" showInfo={false} strokeColor="#faad14" />
            <Text type="secondary" style={{ fontSize: 12 }}>
              Based on {totalReviews} reviews
            </Text>
          </Card>
        </Col>
      </Row>

      {/* Charts Section */}
      <Row gutter={[16, 16]} style={{ marginTop: 24 }}>
        <Col xs={24} lg={16}>
          <Card title="Sales Overview (Last 6 Months)" variant="borderless">
            <Line {...lineChartConfig} />
          </Card>
        </Col>
        
        <Col xs={24} lg={8}>
          <Card title="Product Status" variant="borderless">
            <Pie {...serviceStatusConfig} />
          </Card>
        </Col>
      </Row>

      {/* Recent Orders */}
      <Row gutter={[16, 16]} style={{ marginTop: 24 }}>
        <Col span={24}>
          <Card 
            title="Recent Orders" 
            variant="borderless"
            extra={<Button type="primary" onClick={() => window.location.href = '/vendor/orders'}>View All Orders</Button>}
          >
            <Table
              columns={orderColumns}
              dataSource={recentOrders}
              rowKey="id"
              pagination={false}
            />
          </Card>
        </Col>
      </Row>

      {/* Quick Actions */}
      <Row gutter={[16, 16]} style={{ marginTop: 24 }}>
        <Col xs={24} sm={8}>
          <Card hoverable style={{ textAlign: 'center' }} onClick={() => window.location.href = '/vendor/products/new'}>
            <ShoppingOutlined style={{ fontSize: 48, color: '#1890ff' }} />
            <Title level={4} style={{ marginTop: 16 }}>Add New Product</Title>
            <Button type="primary">Get Started</Button>
          </Card>
        </Col>
        <Col xs={24} sm={8}>
          <Card hoverable style={{ textAlign: 'center' }} onClick={() => window.location.href = '/vendor/orders'}>
            <CheckCircleOutlined style={{ fontSize: 48, color: '#52c41a' }} />
            <Title level={4} style={{ marginTop: 16 }}>Process Orders</Title>
            <Button type="primary">View Pending</Button>
          </Card>
        </Col>
        <Col xs={24} sm={8}>
          <Card hoverable style={{ textAlign: 'center' }} onClick={() => window.location.href = '/vendor/rfq'}>
            <ClockCircleOutlined style={{ fontSize: 48, color: '#faad14' }} />
            <Title level={4} style={{ marginTop: 16 }}>Manage RFQs</Title>
            <Button type="primary">View Requests</Button>
          </Card>
        </Col>
      </Row>

      {/* Advanced Analytics Dashboard */}
      <Row gutter={[16, 16]} style={{ marginTop: 24 }}>
        {/* Real-time Performance Indicators */}
        <Col span={24}>
          <Card title="Real-time Performance" variant="borderless">
            <Row gutter={[16, 16]}>
              <Col xs={24} sm={6}>
                <Statistic
                  title="Revenue Growth"
                  value={revenueGrowth}
                  suffix={formatGrowth(revenueGrowth)}
                  valueStyle={{ color: revenueGrowth >= 0 ? '#52c41a' : '#ff4d4f' }}
                />
              </Col>
              <Col xs={24} sm={6}>
                <Statistic
                  title="Order Growth"
                  value={ordersGrowth}
                  suffix={formatGrowth(ordersGrowth)}
                  valueStyle={{ color: ordersGrowth >= 0 ? '#52c41a' : '#ff4d4f' }}
                />
              </Col>
              <Col xs={24} sm={6}>
                <Statistic
                  title="Conversion Rate"
                  value={stats?.conversionRate || 0}
                  suffix={`% ${formatGrowth(conversionGrowth)}`}
                  valueStyle={{ color: '#1890ff' }}
                />
              </Col>
              <Col xs={24} sm={6}>
                <Statistic
                  title="Customer Retention"
                  value={stats?.customerRetention || 0}
                  suffix={`% ${formatGrowth(stats?.retentionGrowth || 0)}`}
                  valueStyle={{ color: '#722ed1' }}
                />
              </Col>
            </Row>
          </Card>
        </Col>
      </Row>

      {/* Performance Alerts & Insights */}
      {alerts.length > 0 && (
        <Row gutter={[16, 16]} style={{ marginTop: 24 }}>
          <Col span={24}>
            <Card title="Performance Alerts" variant="borderless">
              <List
                dataSource={alerts.slice(0, 5)}
                renderItem={(alert: any) => (
                  <List.Item>
                    <List.Item.Meta
                      avatar={
                        <Avatar 
                          style={{ 
                            backgroundColor: getStatusColor(alert.priority),
                            color: '#fff'
                          }}
                          icon={<AlertOutlined />}
                        />
                      }
                      title={alert.title}
                      description={alert.description}
                    />
                    <Tag color={getStatusColor(alert.priority)}>
                      {alert.priority?.toUpperCase()}
                    </Tag>
                  </List.Item>
                )}
              />
            </Card>
          </Col>
        </Row>
      )}

      {/* Top Products Performance */}
      {topProducts.length > 0 && (
        <Row gutter={[16, 16]} style={{ marginTop: 24 }}>
          <Col span={24}>
            <Card title="Top Performing Products" variant="borderless">
              <List
                dataSource={topProducts}
                renderItem={(product: any) => (
                  <List.Item>
                    <List.Item.Meta
                      avatar={<Avatar icon={<FireOutlined />} style={{ backgroundColor: '#ff7a45' }} />}
                      title={product.name}
                      description={`${product.orders} orders â€¢ ${formatCurrency(product.revenue)} revenue`}
                    />
                    <div style={{ textAlign: 'right' }}>
                      {formatGrowth(product.growth)}
                      <br />
                      <Text type="secondary">{formatCurrency(product.revenue)}</Text>
                    </div>
                  </List.Item>
                )}
              />
            </Card>
          </Col>
        </Row>
      )}

      {/* Enhanced Analytics Data */}
      {analyticsData && (
        <Row gutter={[16, 16]} style={{ marginTop: 24 }}>
          <Col xs={24} lg={12}>
            <Card title="Performance Overview" variant="borderless">
              {analyticsData.performanceIndicators && Object.entries(analyticsData.performanceIndicators).map(([key, indicator]) => (
                <div key={key} style={{ marginBottom: 16 }}>
                  <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                    <Text>{key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase())}</Text>
                    <Tag color={getStatusColor(indicator.status)}>
                      {indicator.status.replace('_', ' ').toUpperCase()}
                    </Tag>
                  </div>
                  <Progress 
                    percent={(indicator.value / indicator.target) * 100} 
                    strokeColor={getStatusColor(indicator.status)}
                    format={() => `${indicator.value}/${indicator.target}`}
                  />
                </div>
              ))}
            </Card>
          </Col>
          
          <Col xs={24} lg={12}>
            <Card title="Quick Insights" variant="borderless">
              <List
                dataSource={analyticsData.quickInsights || []}
                renderItem={(insight: any) => (
                  <List.Item>
                    <List.Item.Meta
                      avatar={
                        <Avatar 
                          icon={<ThunderboltOutlined />} 
                          style={{ backgroundColor: '#52c41a' }}
                        />
                      }
                      title={insight.title}
                      description={insight.description}
                    />
                  </List.Item>
                )}
              />
            </Card>
          </Col>
        </Row>
      )}
    </div>
  );
};

export default VendorDashboard;
